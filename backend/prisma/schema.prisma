generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  USER
}

// Enum para as fontes de dados de consumo
enum ConsumptionSource {
  MANUAL
  IOT
  MODBUS
  ETHERNET_IP
  PROFIBUS
  MQTT
  OPC_UA
}

// ==================== AUTENTICAÇÃO E USUÁRIOS ====================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(USER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  profile         Profile?
  plants          Plant[]
  passwordResets  PasswordReset[]
  revokedTokens   RevokedToken[]
  alerts          Alert[]
  simulations     Simulation[]
  consumptionLogs ConsumptionLog[]

  @@map("users")
}

model Profile {
  id          String   @id @default(uuid())
  fantasyName String   @map("fantasy_name")
  cnpj        String   @unique
  zipCode     String   @map("zip_code")
  address     String
  city        String
  state       String
  phone       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model PasswordReset {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_resets")
}

model RevokedToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("revoked_tokens")
}

// ==================== PROPRIEDADES E ESTRUTURA FÍSICA ====================

model Plant {
  id                   String   @id @default(uuid())
  name                 String
  cnpj                 String   @unique
  zipCode              String   @map("zip_code")
  address              String
  city                 String
  state                String
  totalArea            Float    @map("total_area")
  registeredAreasCount Int      @default(0) @map("registered_areas_count")
  totalConsumption     Float    @default(0) @map("total_consumption")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Rastreia quem criou a planta (apenas admins podem criar)
  createdById String @map("created_by_id")
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Restrict)

  energyCompanyId String?        @map("energy_company_id")
  energyCompany   EnergyCompany? @relation(fields: [energyCompanyId], references: [id], onDelete: SetNull)

  areas       Area[]
  alerts      Alert[]
  simulations Simulation[]

  @@index([createdById])
  @@index([energyCompanyId])
  @@map("plants")
}

model Area {
  id                     String   @id @default(uuid())
  name                   String
  totalArea              Float    @map("total_area")
  registeredDevicesCount Int      @default(0) @map("registered_devices_count")
  totalConsumption       Float    @default(0) @map("total_consumption")
  description            String?
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relacionamento com Plant
  plantId String @map("plant_id")
  plant   Plant  @relation(fields: [plantId], references: [id], onDelete: Cascade)

  devices     Device[]
  alerts      Alert[]
  simulations Simulation[]

  @@index([plantId])
  @@map("areas")
}

model Device {
  id             String  @id @default(uuid())
  name           String
  model          String?
  brand          String?
  workingVoltage Float
  power          Float
  usageTime      Float   @default(0)
  description    String?

  // Relacionamento com área
  areaId String
  area   Area   @relation(fields: [areaId], references: [id], onDelete: Cascade)

  // Campos IoT
  iotDeviceId    String?   @unique
  protocol       String?
  ipAddress      String?
  port           Int?
  endpoint       String?
  isConnected    Boolean   @default(false)
  lastConnection DateTime?

  // Relacionamentos
  consumptionLogs ConsumptionLog[]
  alerts          Alert[]
  simulations     Simulation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([areaId])
  @@index([iotDeviceId])
  @@map("devices")
}

// ==================== CONSUMO DE ENERGIA ====================

model ConsumptionLog {
  id          String            @id @default(uuid())
  consumption Float // Consumo em kWh
  timestamp   DateTime // Data/hora da leitura
  source      ConsumptionSource // Agora é um enum, não string genérico

  // Relacionamento com dispositivo
  deviceId String
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Relacionamento com usuário (quem registrou o log)
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Métricas adicionais opcionais
  voltage     Float? // Voltagem em Volts
  current     Float? // Corrente em Amperes
  powerFactor Float? // Fator de potência (0-1)
  temperature Float? // Temperatura em Celsius

  // Notas/observações
  notes String?

  // Timestamps de auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deviceId])
  @@index([userId])
  @@index([timestamp])
  @@index([source])
  @@map("consumption_logs")
}

model EnergyCompany {
  id    String  @id @default(uuid())
  name  String
  cnpj  String  @unique
  phone String?
  email String?

  tariffKwh     Float   @map("tariff_kwh")
  tariffPeakKwh Float?  @map("tariff_peak_kwh")
  peakStartTime String? @map("peak_start_time")
  peakEndTime   String? @map("peak_end_time")

  greenFlagValue  Float  @default(0) @map("green_flag_value")
  yellowFlagValue Float  @default(0) @map("yellow_flag_value")
  redFlag1Value   Float  @default(0) @map("red_flag1_value")
  redFlag2Value   Float  @default(0) @map("red_flag2_value")
  currentFlag     String @default("green") @map("current_flag")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamento
  plants Plant[]

  @@map("energy_companies")
}

// ==================== ALERTAS E NOTIFICAÇÕES ====================

model Alert {
  id       String  @id @default(uuid())
  title    String
  message  String
  type     String
  severity String
  isRead   Boolean @default(false) @map("is_read")

  threshold      Float?
  comparisonType String? @map("comparison_type")
  timeWindow     String? @map("time_window")
  isActive       Boolean @default(true) @map("is_active")

  triggeredValue Float?    @map("triggered_value")
  triggeredAt    DateTime? @map("triggered_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plantId String? @map("plant_id")
  plant   Plant?  @relation(fields: [plantId], references: [id], onDelete: Cascade)

  areaId String? @map("area_id")
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: Cascade)

  deviceId String? @map("device_id")
  device   Device? @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([isActive])
  @@index([triggeredAt])
  @@map("alerts")
}

// ==================== SIMULAÇÕES DE CONSUMO E CUSTO ====================

model Simulation {
  id          String  @id @default(uuid())
  name        String
  description String?

  simulationType String @map("simulation_type")
  scope          String

  estimatedConsumption Float @map("estimated_consumption")
  estimatedCost        Float @map("estimated_cost")

  startDate         DateTime @map("start_date")
  endDate           DateTime @map("end_date")
  averageDailyUsage Float?   @map("average_daily_usage")
  tariffUsed        Float    @map("tariff_used")
  flagUsed          String?  @map("flag_used")

  realConsumption Float? @map("real_consumption")
  variance        Float?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plantId String? @map("plant_id")
  plant   Plant?  @relation(fields: [plantId], references: [id], onDelete: Cascade)

  areaId String? @map("area_id")
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: Cascade)

  deviceId String? @map("device_id")
  device   Device? @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scope])
  @@index([createdAt])
  @@map("simulations")
}
